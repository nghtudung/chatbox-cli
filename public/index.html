<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chat Box</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="header">
    <h2>Chat Box</h2>
    <a href="/help.html">help me</a>
    <div id="user-input">
      <input type="text" id="username" placeholder="Enter your name..." />
      <button id="setname">Set Nickname</button>
    </div>
  </div>

  <div id="chat"></div>

  <div id="input-area">
    <textarea id="message" placeholder="What's on your mind?" rows="4" disabled></textarea>
    <div id="buttons">
      <button id="send" disabled>Send</button>
      <button id="send-code" disabled>Send Code</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const chat = document.getElementById('chat');
        const messageInput = document.getElementById('message');
        const sendBtn = document.getElementById('send');
        const usernameInput = document.getElementById('username');
        const setNameBtn = document.getElementById('setname');
        const sendCodeBtn = document.getElementById('send-code');

        let currentUser = null;

        // Xử lý Enter và Shift+Enter trong textarea
        messageInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                if (e.shiftKey) {
                    // Shift + Enter gửi code
                    e.preventDefault();
                    sendCodeBtn.click();
                } else {
                    // Enter gửi tin nhắn thường
                    e.preventDefault();
                    sendBtn.click();
                }
            }
        });

        setNameBtn.onclick = () => {
            const name = usernameInput.value.trim();
            if (name !== '') {
                socket.emit('join', name);
                currentUser = name;
                usernameInput.disabled = true;
                setNameBtn.disabled = true;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                sendCodeBtn.disabled = false;
                messageInput.focus();
            }
        };

        sendBtn.onclick = () => {
            const msg = messageInput.value.trim();
            if (msg !== '') {
                socket.emit('chat-message', msg);
                messageInput.value = '';
            }
        };

        sendCodeBtn.onclick = () => {
            const msg = messageInput.value;
            if (msg.trim() !== '') {
                socket.emit('chat-message', "```" + msg + "```");
                messageInput.value = '';
            }
        };

        socket.on('chat-message', data => {
            const label = data.user === currentUser ? 'Bạn' : data.user;
            addMessage(label, data.message);
        });

        socket.on('user-joined', msg => {
            addSystemMessage(msg);
        });

        socket.on('user-left', msg => {
            addSystemMessage(msg);
        });

        function addMessage(user, msg) {
            const div = document.createElement('div');
            div.classList.add('message');

            if (msg.startsWith("```") && msg.endsWith("```")) {
                const codeContent = msg.slice(3, -3);
                const pre = document.createElement('pre');
                const code = document.createElement('code');
                code.textContent = codeContent;
                pre.appendChild(code);
                pre.style.fontFamily = 'monospace';
                pre.style.background = '#f4f4f4';
                pre.style.padding = '10px';
                pre.style.borderRadius = '5px';
                pre.style.whiteSpace = 'pre-wrap';
                pre.style.position = 'relative';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Copy';
                copyBtn.style.position = 'absolute';
                copyBtn.style.top = '5px';
                copyBtn.style.right = '5px';
                copyBtn.style.padding = '2px 8px';
                copyBtn.style.fontSize = '12px';
                copyBtn.style.cursor = 'pointer';

                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(codeContent).then(() => {
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                    }).catch(() => {
                        alert('Copy failed!');
                    });
                };

                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                wrapper.appendChild(pre);
                wrapper.appendChild(copyBtn);

                div.innerHTML = `<span class="user">${user}:</span>`;
                div.appendChild(wrapper);
            } else {
                div.innerHTML = `<span class="user">${user}:</span> ${escapeHtml(msg)}`;
            }

            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function addSystemMessage(msg) {
            const div = document.createElement('div');
            div.classList.add('message');
            div.style.fontStyle = 'italic';
            div.style.color = 'gray';
            div.textContent = msg;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>